<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">

<head>
    <title>GURU Able - Free Lite Admin Template </title>
    <!-- HTML5 Shim and Respond.js IE9 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Meta -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="description" content="CodedThemes">
    <meta name="keywords"
          content=" Admin , Responsive, Landing, Bootstrap, App, Template, Mobile, iOS, Android, apple, creative app">
    <meta name="author" content="CodedThemes">
    <!-- Favicon icon -->
    <link rel="icon" href="/images/favicon.ico" type="image/x-icon">
    <!-- Google font-->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600" rel="stylesheet">
    <!-- Required Fremwork -->
    <link rel="stylesheet" type="text/css" href="/css/bootstrap/css/bootstrap.min.css">
    <!-- themify-icons line icon -->
    <link rel="stylesheet" type="text/css" href="/icon/themify-icons/themify-icons.css">
    <!-- ico font -->
    <link rel="stylesheet" type="text/css" href="/icon/icofont/css/icofont.css">

    <!-- Style.css -->
    <link rel="stylesheet" type="text/css" href="/css/style.css">
    <link rel="stylesheet" type="text/css" href="/css/jquery.mCustomScrollbar.css">
    <style>
        .btn-card {
          text-transform: uppercase;
          font-size: 13px;
          padding: 5px 10px;
          margin: 0px 10px;
          color: #fff;
          border-radius: 5px;
      }
       table{
        border-collapse: collapse;
        border-spacing: 0
       }
       th{
           background-color: #f6f7fb;
       color: #000;
       }
       th, td{
           border: 1px solid #ccc;
       padding: 10px;
       }
       input{
           border:none;
       }
       .container{
           display: flex;
           max-width: 1141px;
           flex-flow: column;
           justify-content: center;
           align-items: center;
       }
       .btn-display{
        display: flex;
        justify-content: center;
        margin-bottom:20px;
       }
       button{
           margin:10px;
       }
        textarea {
       border: none;
       resize: none;
   }
    </style>
</head>

<body>
<!-- Pre-loader start -->

<!-- Pre-loader end -->
<div id="pcoded" class="pcoded">
    <div class="pcoded-overlay-box"></div>
    <div class="pcoded-container navbar-wrapper">
        <nav class="navbar header-navbar pcoded-header" th:include="includes/header :: header"
             th:with="name=${user.name}, part=${user.part}, roles=${user.roles}"></nav>

        <div class="pcoded-main-container">
            <div th:include="includes/navbar :: navbar"
                 th:with="name=${user.name}, part=${user.part}, roles=${user.roles}"></div>
            <div class="pcoded-content">
                <div class="pcoded-inner-content">
                    <div class="main-body">
                        <div class="page-wrapper">
                            <div class="page-header card">
                                <div class="row align-items-end">
                                    <div class="col-lg-8">
                                        <div class="page-header-title">
                                            <i class="icofont icofont-table" style="background-color: #FC6180;"></i>
                                            <div style="display:flex; align-items:center;">
                                                <h4> 견적서 </h4>

                                            </div>
                                        </div>
                                    </div>
                                </div>


                            </div>
                            <div class="page-body">


                                <div class="card">
                                    <form>

                                    <div class="card-header">
                                        <div class="container">
                                        <h1>견 적 서</h1>



                                            <table id="estimateTable" width="90%" >

                                            <tr>
                                                <th colspan="2">견적서번호</th>
                                                <td colspan="3">
                                                    <input type="text" th:value="${quotation.id}" id="quotationId" readonly>
                                                </td>
                                                <th colspan="2">회사명</th>
                                                <td colspan="3">
                                                    <input type="text" id="company_name" th:value="${quotation.company_name}" readonly>
                                                </td>

                                            </tr>
                                            <tr>
                                                <th rowspan="2" colspan="2">수신</th>
                                                <td rowspan="2" colspan="3">
                                                    <p style="font-size: larger;"><u>GURO자전거</u></p>
                                                    <p><u>권나현 대표 귀하</u></p>
                                                </td>
                                                <th rowspan="1" colspan="2">사업자번호</th>
                                                <td colspan="3">
                                                    <input type="text" id="company_id" th:value="${quotation.Company.companyId}" readonly>
                                                </td>
                                            </tr>
                                            <tr>
                                                <th rowspan="1" colspan="2">Bidding No.</th>
                                                <td colspan="3" th:text="${quotation.biddingNo}">
                                                </td>
                                            </tr>
                                            <tr>
                                                <th rowspan="2" colspan="2">주소</th>
                                                <td colspan="3" rowspan="2" th:text="${quotation.Company.address}">
                                                </td>
                                                <th colspan="2" rowspan="2">대표자(혹은 담당자)</th>
                                                <th>성명</th>
                                                <td colspan="2" th:text="${quotation.Company.ceo}">>

                                                </td>
                                            </tr>
                                            <tr>
                                                <th >연락처</th>
                                                <td colspan="2" th:text="${quotation.Company.tel}">

                                                </td>
                                            </tr>
                                                <tr>
                                                    <th colspan="2">리드타임</th>
                                                    <td colspan="3" th:text="${quotation.leadTime}">

                                                    </td>
                                                    <th colspan="2">거래조건</th>
                                                    <td colspan="3" th:text="${quotation.tradeTerms}">

                                                    </td>

                                                </tr>
                                                <tr>
                                                    <th colspan="2">지불조건</th>
                                                    <td colspan="3" th:text="${quotation.paymentTerms}"></td>
                                                    <th colspan="2">납기일</th>
                                                    <td colspan="3" th:text="${quotation.deadline}"></td>
                                                </tr>

                                            <tr>
                                                <th>No</th>
                                                <th>PID</th>
                                                <th colspan="2">품명</th>
                                                <th>규격</th>
                                                <th>수량</th>
                                                <th>단위</th>
                                                <th>단가</th>
                                                <th colspan="2">금액</th>


                                            </tr>

                                            <tbody id="tableBody">

                                            </tbody>


                                            <tr th:each="qd, itemStat : ${quotationDetailDTOList}">
                                                <th scope="row" th:text="${itemStat.count}"></th>
                                                <td th:text="${qd.Material.materialId}"></td>
                                                <td colspan="2" th:text="${qd.Material.materialName}"></td>
                                                <td th:text="${qd.Material.materialDescription}"></td>
                                                <td th:text="${qd.quotationCnt}"></td>
                                                <td th:text="${qd.quotationMeasure}"></td>
                                                <td th:text="${qd.quotationPrice}"></td>
                                                <td colspan="2" th:text="${qd.quotationPrice*qd.quotationCnt}"></td>
                                            </tr>
                                            <!---------------------------------------------------->
                                            <tr>
                                                <th colspan="3">합계(VAT 포함)</th>

                                                <td colspan="7" class="total" th:text="${quotation.quotation_totalprice}"></td>

                                            </tr>
                                            <tr>
                                                <th colspan="2">특기사항</th>
                                                <td colspan="8" th:text="${quotation.quotation_memo}"></td>
                                            </tr>

                                        </table>


                                    </div>
                                    </div>

                                    <div class="btn-display">
                                        <input type="button"  th:attr="onclick='acceptQuotaion()'" class="btn btn-warning" style="background-color: #FC6180; border-color: #FC6180; margin:10px;" value="수락"/>
                                        <input type="button"  th:attr="onclick='dropQuotation()'" class="btn btn-warning" style="background-color: #FC6180; border-color: #FC6180; margin:10px;" value="거절"/>
                                        <input type="button"  th:attr="onclick='deleteQuotation()'" class="btn btn-warning" style="background-color: #FC6180; border-color: #FC6180; margin:10px;" value="삭제"/>
                                        <input type="button"
                                                th:attr="onclick='gotoList()'"
                                                class="btn btn-warning"
                                                style="background-color: #FC6180; border-color: #FC6180;  margin:10px;" value="목록"/>
                                    </div>
                                    </form>

                                </div>


                            </div>
                            <div id="styleSelector">

                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

    </div>
</div>
<!-- Warning Section Starts -->
<!-- Older IE warning message -->

<![endif]-->
<!-- Warning Section Ends -->
<!-- Required Jquery -->
<script type="text/javascript" src="/js/jquery/jquery.min.js"></script>
<script type="text/javascript" src="/js/jquery-ui/jquery-ui.min.js"></script>
<script type="text/javascript" src="/js/popper.js/popper.min.js"></script>
<script type="text/javascript" src="/js/bootstrap/js/bootstrap.min.js"></script>
<!-- jquery slimscroll js -->
<script type="text/javascript" src="/js/jquery-slimscroll/jquery.slimscroll.js"></script>
<!-- modernizr js -->
<script type="text/javascript" src="/js/modernizr/modernizr.js"></script>
<!-- am chart -->
<script src="/pages/widget/amchart/amcharts.min.js"></script>
<script src="/pages/widget/amchart/serial.min.js"></script>
<!-- Todo js -->
<script type="text/javascript " src="/pages/todo/todo.js "></script>
<!-- Custom js -->
<script type="text/javascript" src="/pages/dashboard/custom-dashboard.js"></script>
<script type="text/javascript" src="/js/script.js"></script>
<script type="text/javascript " src="/js/SmoothScroll.js"></script>
<script src="/js/pcoded.min.js"></script>
<script src="/js/demo-12.js"></script>
<script src="/js/jquery.mCustomScrollbar.concat.min.js"></script>
<script>



  function gotoList(){
    var url = '/plan/quotation';
    window.location.href = url;
}


  function addCompany() {


    var newWindow = window.open('/plan/company_search', '_blank', 'width=1000,height=800');
    if (newWindow) {
        newWindow.focus();
    } else {
        alert('팝업이 차단되었습니다. 팝업 차단을 해제하고 다시 시도하세요.');
    }
}

      function comapnyInput(rowData) {
        // rowData를 사용하여 각 ID에 값을 채우는 동작을 수행

        // 예: 각 ID에 해당하는 요소를 찾아서 값 채우기
        document.getElementById("company_name").value = rowData[0];
        document.getElementById("company_id").value = rowData[1];
        document.getElementById("companyAddress").value = rowData[5];
        document.getElementById("companyCeo").value = rowData[2];
        document.getElementById("phoneNumber").value = rowData[3];

        // 나머지 필요한 데이터에 대해서도 동일한 방식으로 처리 가능
    }


// 행을 반대로 삭제하는 메서드


function deleteRow() {
var table = document.getElementById("tableBody");
var rowCount = table.rows.length;

if (rowCount > 0) { // 최소한의 행이 유지되도록 설정
    table.deleteRow(rowCount - 1); // 맨 끝 행 삭제
}
}


// 품목 추가를 위한 행 추가 기능 시작

   function addRow() {


    var newWindow = window.open('/plan/item_search', '_blank', 'width=800,height=800');
    if (newWindow) {
        newWindow.focus();
    } else {
        alert('팝업이 차단되었습니다. 팝업 차단을 해제하고 다시 시도하세요.');
    }
}


function check(materialId) {

console.log(materialId);

var xhr = new XMLHttpRequest();
var url = '/plan/material_search/' + materialId; // 실제 컨트롤러 엔드포인트 URL로 변경해주세요

xhr.onreadystatechange = function() {
    if (xhr.readyState === XMLHttpRequest.DONE) {
        if (xhr.status === 200) {
            var materialDTO = JSON.parse(xhr.responseText);
            console.log(materialDTO); // 가져온 데이터 확인

            var companyId = materialDTO.companyId;
            var materialCategory = materialDTO.materialCategory;
            var materialCode = materialDTO.materialCode;
            var materialDescription = materialDTO.materialDescription;
            var materialId = materialDTO.materialId;
            var materialMeasure = materialDTO.materialMeasure;
            var materialName = materialDTO.materialName;
            var materialPrice = materialDTO.materialPrice;




                var table = document.getElementById("tableBody");
                var rows = table.getElementsByTagName("tr");
                var rowNum = rows.length;
                var row = table.insertRow(-1);


                   var idInput = "index"+rowNum;
                var cell = row.insertCell(0);
                   cell.setAttribute("id", idInput);
                 cell.appendChild(document.createTextNode(""));



                 cell = row.insertCell(1);
                 cell.colSpan = "2";
                idInput = "materialId"+rowNum;
                   cell.setAttribute("id", idInput);
                 cell.appendChild(document.createTextNode(materialId));

                 cell = row.insertCell(2);
                 cell.colSpan = "1";
                    idInput = "materialName"+rowNum;
                   cell.setAttribute("id", idInput);
                 cell.appendChild(document.createTextNode(materialName));

                 cell = row.insertCell(3); //규격
                 cell.colSpan = "1";
                  idInput = "materialDescription"+rowNum;
                   cell.setAttribute("id", idInput);
                 cell.appendChild(document.createTextNode(materialDescription));

                 cell = row.insertCell(4); //수량
                 cell.colSpan = "1";
                 var input = document.createElement("input");
                    input.setAttribute("type", "text");
                    input.classList.add("countNumber");
                    cell.appendChild(input);

                 cell = row.insertCell(5); //단위
                 cell.colSpan = "1";
                     idInput = "materialMeasure"+rowNum;
                   cell.setAttribute("id", idInput);
                 cell.appendChild(document.createTextNode(materialMeasure));

                 cell = row.insertCell(6); //단가
                 cell.colSpan = "1";
                    idInput = "materialPrice"+rowNum;
                   cell.setAttribute("id", idInput);

                 cell.appendChild(document.createTextNode(materialPrice));

                 cell = row.insertCell(7); //금액
                 cell.colSpan = "1";
                  idInput = "materialMeasure"+rowNum;
                    cell.setAttribute("id", idInput);


                    cell.classList.add("totalPrice");



                 renumberRows();
                 row.style.width = "60%";

                    var elements = document.getElementsByClassName('countNumber');
                     var totalPrice = 0;

                    for (var i = 0; i < elements.length; i++) {

                        elements[i].addEventListener('input', function() {
                            var row = this.parentNode.parentNode; // 현재 요소의 부모 요소인 셀의 부모 요소인 행을 가져옵니다.

                            var input1Value = parseFloat(row.cells[4].children[0].value); // cell = row.insertCell(4); 셀의 값
                            var input2Value = parseFloat(row.cells[6].textContent); // cell = row.insertCell(6); 셀의 값

                            // 두 값이 모두 숫자인 경우에만 곱셈을 진행합니다.
                            if (!isNaN(input1Value) && !isNaN(input2Value)) {
                              var multiplicationResult = input1Value * input2Value; // 두 값의 곱셈


                                // 결과가 숫자가 아니거나 Infinity 또는 -Infinity인 경우 빈 문자열로 대체합니다.
                                row.cells[7].textContent = isFinite(multiplicationResult) ? multiplicationResult : '';

                                // 'totalPrice' 클래스를 가진 모든 input 요소를 선택합니다.
totalPriceInputs = document.querySelectorAll('.totalPrice');


    updateTotalSumOfAllRows();
                            } else {
                                row.cells[7].textContent = ''; // 하나라도 숫자가 아니면 빈 문자열로 표시합니다.
                            }
                        });
                    }
        } else {
            console.log('Request failed. Status: ' + xhr.status);
        }
    }
};
 xhr.open('GET', url, true);
xhr.send();
}

var totalPriceInputs;

// 모든 행에 대한 총합을 갱신하는 함수
function updateTotalSumOfAllRows() {
    var grandTotalSum = 0;

    // 각 'totalPrice' 클래스를 가진 td 또는 input 요소의 값을 가져와서 총합을 계산합니다.
    totalPriceInputs.forEach(function (element) {
        var inputValue;

        // td 안의 텍스트 값을 가져옴
        if (element.tagName.toLowerCase() === 'td') {
            inputValue = parseFloat(element.textContent);
        } else if (element.tagName.toLowerCase() === 'input') {
            inputValue = parseFloat(element.value);
        }

        if (!isNaN(inputValue)) {
            grandTotalSum += inputValue;
        }
    });

    // 변경된 전체 '총합'을 콘솔에 출력합니다.

    // 변경된 전체 '총합'을 'total' 클래스를 가진 td에 업데이트합니다.
    var totalTd = document.querySelector('td.total'); // 적절한 선택자를 사용하여 'total' 클래스를 가진 td를 찾습니다.

    if (totalTd) {
        totalTd.textContent = grandTotalSum;
    } else {
        console.error("Total TD not found!"); // 적절한 td를 찾지 못한 경우 에러를 출력합니다.
    }
}



// 첫셀에서 index 주는 메서드

function renumberRows() {
 var rowNum = 0; // 초기 번호
var table = document.getElementById("tableBody");
var rows = table.getElementsByTagName("tr");

for (var i = 0; i < rows.length; i++) {
    var cells = rows[i].getElementsByTagName("td");
    if (cells.length > 0) {
        cells[0].innerText = ++rowNum; // 첫 번째 셀에 순차적으로 번호를 매깁니다.
    }
}
}

//index 기능 종료



function acceptQuotaion(){
var quotationId = document.getElementById('quotationId').value;
    $.ajax({
        type: 'POST',
        url: '/plan/quotation_accept',
        contentType: 'application/json',
        data: quotationId,
        success: function (response) {
            alert(response);
            window.location.href = '/plan/quotation';
        },
        error: function (error) {
            alert('삭제실패:', error);
        }
    });
}



function dropQuotation(){
var quotationId = document.getElementById('quotationId').value;
    $.ajax({
        type: 'POST',
        url: '/plan/quotation_drop',
        contentType: 'application/json',
        data: quotationId,
        success: function (response) {
            alert(response);
           window.location.href = '/plan/quotation';
        },
        error: function (error) {
            alert('삭제실패:', error);
        }
    });
}


function deleteQuotation(){
var quotationId = document.getElementById('quotationId').value;
    $.ajax({
        type: 'POST',
        url: '/plan/quotation_delete',
        contentType: 'application/json',
        data: quotationId,
        success: function (response) {
            alert(response);
            // 필요한 작업 수행, 예: 페이지 리로드 또는 다른 업데이트
        },
        error: function (error) {
            alert('삭제실패:', error);
        }
    });
}



</script>
</body>

</html>
